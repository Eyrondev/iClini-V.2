<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iClinic Reports - Norzagaray College</title>
    <script src="/assets/js/libs/chart.min.js"></script>
    <script defer src="/assets/js/libs/alpine.min.js"></script>
    <link href="/assets/css/libs/inter-font.css" rel="stylesheet">
    
    <style>
        * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        body { background: white; padding: 40px; }
        @media print {
            .no-print { display: none !important; }
            body { print-color-adjust: exact; -webkit-print-color-adjust: exact; padding: 20px; }
        }
    </style>
</head>
<body x-data="printReportsModule()" x-init="init()">
    
    <!-- Print Button -->
    <div class="no-print" style="position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; gap: 10px;">
        <button onclick="window.print()" style="background: #2563eb; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer;">
            Print Report
        </button>
        <button onclick="window.history.back()" style="background: #6b7280; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer;">
            Back
        </button>
    </div>
    
    <!-- Official Header -->
    <div style="text-align: center; margin-bottom: 40px;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 40px; margin-bottom: 20px;">
            <img src="{{ url_for('static', filename='img/iclinic-logo.png') }}" alt="Norzagaray College Logo" style="width: 80px; height: 80px; object-fit: contain;">
            <div>
                <h1 style="font-size: 16px; font-weight: 900; color: black; margin: 0; letter-spacing: 1px;">NORZAGARAY COLLEGE</h1>
                <p style="font-size: 12px; font-weight: 600; color: black; margin: 2px 0;">Municipal Compound, Brgy. Poblacion</p>
                <p style="font-size: 12px; font-weight: 600; color: black; margin: 2px 0;">Norzagaray, Bulacan</p>
            </div>
        </div>
        
    
    <!-- Main Table Layout -->
    <table style="width: 100%; border-collapse: collapse; border: 2px solid black;">
        <tr>
            <!-- SUMMARY Column -->
            <td style="width: 40%; border: 2px solid black; vertical-align: top; padding: 0;">
                <div style="background: black; color: white; text-align: center; padding: 8px; font-weight: 700; font-size: 14px;">
                    SUMMARY
                </div>
                <div style="padding: 20px;">
                    <!-- Summary Stats -->
                    <div style="margin-bottom: 20px;">
                        <div style="border-bottom: 1px solid #ccc; padding: 10px 0;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">Total Patients</div>
                            <div style="font-size: 24px; font-weight: 900; color: black;" x-text="summaryData.totalPatients">0</div>
                        </div>
                        <div style="border-bottom: 1px solid #ccc; padding: 10px 0;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">Total Visits</div>
                            <div style="font-size: 24px; font-weight: 900; color: black;" x-text="summaryData.totalVisits">0</div>
                        </div>
                        <div style="border-bottom: 1px solid #ccc; padding: 10px 0;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">Consultations</div>
                            <div style="font-size: 24px; font-weight: 900; color: black;" x-text="summaryData.totalConsultations">0</div>
                        </div>
                        <div style="padding: 10px 0;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">Medicine Items</div>
                            <div style="font-size: 24px; font-weight: 900; color: black;" x-text="summaryData.medicineStock">0</div>
                        </div>
                    </div>
                    
                    <!-- Additional Info -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid black;">
                        <div style="font-size: 10px; color: #666; margin-bottom: 5px;">
                            <strong>Report Date:</strong><br>
                            <span x-text="currentDate"></span>
                        </div>
                        <div style="font-size: 10px; color: #666; margin-top: 10px;">
                            <strong>Generated By:</strong><br>
                            {{ user.first_name }} {{ user.last_name }}
                        </div>
                        <div style="font-size: 10px; color: #666; margin-top: 10px;">
                            <strong>Academic Year:</strong><br>
                            <span x-text="reportPeriod">2024-2025</span>
                        </div>
                    </div>
                </div>
            </td>
            
            <!-- REPORTS Column -->
            <td style="width: 60%; border: 2px solid black; vertical-align: top; padding: 0;">
                <div style="background: black; color: white; text-align: center; padding: 8px; font-weight: 700; font-size: 14px;">
                    REPORTS
                </div>
                <div style="padding: 20px;">
                    <!-- Charts -->
                    <div style="margin: 20px 0;">
                        <h4 style="font-size: 12px; font-weight: 700; color: black; margin-bottom: 10px; text-align: center;">Monthly Visits Trend</h4>
                        <canvas id="monthlyVisitsChart" style="max-height: 150px; height: 150px;"></canvas>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="font-size: 12px; font-weight: 700; color: black; margin-bottom: 10px; text-align: center;">Patient Demographics</h4>
                        <canvas id="genderChart" style="max-height: 150px; height: 150px;"></canvas>
                    </div>
                </div>
            </td>
        </tr>
    </table>
    
    <!-- Signature -->
    <div style="margin-top: 60px; text-align: center;">
        <div style="display: inline-block; width: 300px;">
            <div style="border-bottom: 2px solid black; margin-bottom: 5px; padding-bottom: 20px;"></div>
            <p style="font-weight: 700; font-size: 11px; margin: 0;">Clinic Nurse</p>
            <p style="font-size: 10px; color: #666; margin: 2px 0;">Prepared By</p>
        </div>
    </div>
    
    <script>
        function printReportsModule() {
            return {
                summaryData: { totalPatients: 0, totalVisits: 0, totalConsultations: 0, medicineStock: 0 },
                demographics: { male: 0, female: 0, students: 0, teaching: 0, nonTeaching: 0, visitors: 0 },
                currentDate: '', reportPeriod: '2024-2025',
                
                async init() {
                    const now = new Date();
                    this.currentDate = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    await this.loadAllData();
                    setTimeout(() => this.initializeAllCharts(), 500);
                },
                
                async loadAllData() {
                    try {
                        const patientsRes = await fetch('/api/patients');
                        const patientsData = await patientsRes.json();
                        if (patientsData.patients) {
                            this.summaryData.totalPatients = patientsData.patients.length;
                            this.demographics.male = patientsData.patients.filter(p => p.gender?.toLowerCase() === 'male').length;
                            this.demographics.female = patientsData.patients.filter(p => p.gender?.toLowerCase() === 'female').length;
                            this.demographics.students = patientsData.patients.filter(p => p.role === 'Student').length;
                            this.demographics.teaching = patientsData.patients.filter(p => p.role === 'Teaching Staff').length;
                            this.demographics.nonTeaching = patientsData.patients.filter(p => p.role === 'Non-Teaching Staff').length;
                            this.demographics.visitors = patientsData.patients.filter(p => p.role === 'Visitor').length;
                        }
                        
                        const visitsRes = await fetch('/api/visits');
                        const visitsData = await visitsRes.json();
                        this.summaryData.totalVisits = visitsData.visits?.length || 0;
                        
                        const consultRes = await fetch('/api/consultations');
                        const consultData = await consultRes.json();
                        this.summaryData.totalConsultations = consultData.consultations?.length || 0;
                        
                        const medRes = await fetch('/api/medicine');
                        const medData = await medRes.json();
                        this.summaryData.medicineStock = medData.medicines?.length || 0;
                    } catch (error) {
                        console.error('Error loading data:', error);
                    }
                },
                
                initializeAllCharts() {
                    this.initGenderChart();
                    this.initPatientTypeChart();
                    this.initMonthlyVisitsChart();
                },
                
                initGenderChart() {
                    const ctx = document.getElementById('genderChart');
                    if (!ctx) return;
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Male', 'Female'],
                            datasets: [{ data: [this.demographics.male, this.demographics.female], backgroundColor: ['#3b82f6', '#ec4899'] }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                },
                
                initPatientTypeChart() {
                    const ctx = document.getElementById('patientTypeChart');
                    if (!ctx) return;
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['Students', 'Teaching', 'Non-Teaching', 'Visitors'],
                            datasets: [{ 
                                data: [this.demographics.students, this.demographics.teaching, this.demographics.nonTeaching, this.demographics.visitors],
                                backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                },
                
                initMonthlyVisitsChart() {
                    const ctx = document.getElementById('monthlyVisitsChart');
                    if (!ctx) return;
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                            datasets: [{
                                label: 'Clinic Visits',
                                data: [45, 52, 38, 65, 48, 72, 58, 63, 55, 48, 35, 28],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            }
        }
    </script>
</body>
</html>
