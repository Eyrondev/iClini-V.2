<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iClinic System Report - Norzagaray College</title>
    
    <!-- Chart.js -->
    <script src="/assets/js/libs/chart.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: #f5f5f5;
            padding: 20px;
        }
        
        .print-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        /* Header Section */
        .report-header {
            background: linear-gradient(135deg, #0056b3 0%, #003d82 100%);
            padding: 30px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .report-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: rgba(253, 184, 19, 0.1);
            border-radius: 50%;
            transform: translate(50%, -50%);
        }
        
        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .logo-section {
            flex-shrink: 0;
        }
        
        .logo-section img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .header-info {
            flex: 1;
        }
        
        .header-info h1 {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #FDB813;
        }
        
        .header-info h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .header-meta {
            display: flex;
            gap: 30px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-meta-item strong {
            color: #FDB813;
        }
        
        /* Summary Cards */
        .summary-section {
            padding: 30px;
            background: #f8f9fa;
        }
        
        .summary-title {
            font-size: 24px;
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #FDB813;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #0056b3;
            transition: transform 0.2s;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .summary-card.patients { border-left-color: #0056b3; }
        .summary-card.appointments { border-left-color: #10b981; }
        .summary-card.medicines { border-left-color: #f59e0b; }
        .summary-card.consultations { border-left-color: #8b5cf6; }
        
        .summary-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .summary-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .summary-card.patients .summary-card-icon { background: #dbeafe; }
        .summary-card.appointments .summary-card-icon { background: #d1fae5; }
        .summary-card.medicines .summary-card-icon { background: #fef3c7; }
        .summary-card.consultations .summary-card-icon { background: #ede9fe; }
        
        .summary-card-value {
            font-size: 36px;
            font-weight: bold;
            color: #1f2937;
        }
        
        .summary-card-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .summary-card-trend {
            margin-top: 10px;
            font-size: 13px;
            color: #10b981;
            font-weight: 600;
        }
        
        /* Charts Section */
        .charts-section {
            padding: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .chart-wrapper {
            position: relative;
            height: 350px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }
        
        /* Data Table */
        .data-table-section {
            padding: 30px;
            background: #f8f9fa;
        }
        
        .data-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table thead {
            background: linear-gradient(135deg, #0056b3 0%, #003d82 100%);
            color: white;
        }
        
        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
            color: #4b5563;
        }
        
        .data-table tbody tr:hover {
            background: #f9fafb;
        }
        
        /* Footer */
        .report-footer {
            padding: 30px;
            background: #1f2937;
            color: white;
            text-align: center;
        }
        
        .report-footer p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        /* Print Styles */
        @media print {
            body {
                padding: 0;
                background: white;
            }
            
            .print-container {
                box-shadow: none;
                max-width: 100%;
            }
            
            .no-print {
                display: none !important;
            }
            
            .chart-wrapper {
                height: 300px;
            }
            
            .summary-card,
            .chart-container {
                page-break-inside: avoid;
            }
        }
        
        /* Print Button */
        .print-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #0056b3 0%, #003d82 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,86,179,0.4);
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .print-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,86,179,0.5);
        }
        
        .print-button:active {
            transform: translateY(-1px);
        }
    </style>

    
    <!-- Mobile Responsive Styles -->
    <style id="mobile-responsive-styles">
        /* Mobile-first responsive utilities */
        @media (max-width: 640px) {
            /* Extra small devices */
            .xs\:text-xs { font-size: 0.75rem; }
            .xs\:text-sm { font-size: 0.875rem; }
            .xs\:p-2 { padding: 0.5rem; }
            .xs\:px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
            .xs\:py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
            .xs\:gap-2 { gap: 0.5rem; }
            .xs\:grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
            .xs\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        
        /* Touch-friendly targets for mobile */
        @media (max-width: 768px) {
            button, a, input, select, textarea {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Ensure modals are mobile-friendly */
            .modal-content {
                max-width: calc(100vw - 2rem);
                margin: 1rem;
            }
            
            /* Stack elements on mobile */
            .mobile-stack {
                flex-direction: column !important;
            }
            
            /* Hide on mobile */
            .mobile-hide {
                display: none !important;
            }
            
            /* Full width on mobile */
            .mobile-full {
                width: 100% !important;
            }
        }
        
        /* Tablet optimization */
        @media (min-width: 641px) and (max-width: 1024px) {
            .tablet-hide {
                display: none !important;
            }
        }
        
        /* Responsive tables */
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .responsive-table {
                min-width: 600px;
            }
        }
        
        /* Responsive grid adjustments */
        @media (max-width: 640px) {
            .grid-cols-2, .grid-cols-3, .grid-cols-4 {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }
            
            .sm\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
        }
        
        /* Responsive padding and margins */
        @media (max-width: 640px) {
            .p-6 { padding: 1rem !important; }
            .p-8 { padding: 1.5rem !important; }
            .px-6 { padding-left: 1rem !important; padding-right: 1rem !important; }
            .py-6 { padding-top: 1rem !important; padding-bottom: 1rem !important; }
        }
    </style>

    
    <style>
        /* Custom scrollbar for tables */
        .scrollbar-thin::-webkit-scrollbar {
            height: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Responsive font sizes */
        @media (max-width: 640px) {
            h1 { font-size: 1.5rem !important; }
            h2 { font-size: 1.25rem !important; }
            h3 { font-size: 1.125rem !important; }
        }
        
        /* Mobile-optimized spacing */
        @media (max-width: 640px) {
            .gap-6 { gap: 1rem !important; }
            .gap-8 { gap: 1.5rem !important; }
            .space-y-6 > * + * { margin-top: 1rem !important; }
        }
    </style>
</head>
<body>
    <div class="print-container">
        <!-- Header Section -->
        <div class="report-header">
            <div class="header-content">
                <div class="logo-section">
                    <img src="../../assets/img/iclinic-logo.png" alt="Norzagaray College Logo">
                </div>
                <div class="header-info">
                    <h1>NORZAGARAY COLLEGE</h1>
                    <h2>iClinic System Report</h2>
                    <div class="header-meta">
                        <div class="header-meta-item">
                            <strong>Report Date:</strong>
                            <span id="reportDate"></span>
                        </div>
                        <div class="header-meta-item">
                            <strong>Academic Year:</strong>
                            <span>2024-2025</span>
                        </div>
                        <div class="header-meta-item">
                            <strong>Generated By:</strong>
                            <span>System Administrator</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <h2 class="summary-title">📊 Executive Summary</h2>
            <div class="summary-grid">
                <div class="summary-card patients">
                    <div class="summary-card-header">
                        <div>
                            <div class="summary-card-value" id="totalPatients">0</div>
                            <div class="summary-card-label">Total Patients</div>
                        </div>
                        <div class="summary-card-icon">👥</div>
                    </div>
                    <div class="summary-card-trend">↑ +12% from last month</div>
                </div>

                <div class="summary-card appointments">
                    <div class="summary-card-header">
                        <div>
                            <div class="summary-card-value" id="totalAppointments">0</div>
                            <div class="summary-card-label">Total Appointments</div>
                        </div>
                        <div class="summary-card-icon">📅</div>
                    </div>
                    <div class="summary-card-trend">↑ +8% from last week</div>
                </div>

                <div class="summary-card medicines">
                    <div class="summary-card-header">
                        <div>
                            <div class="summary-card-value" id="totalMedicines">0</div>
                            <div class="summary-card-label">Medicine Items</div>
                        </div>
                        <div class="summary-card-icon">💊</div>
                    </div>
                    <div class="summary-card-trend">Stock Level: Good</div>
                </div>

                <div class="summary-card consultations">
                    <div class="summary-card-header">
                        <div>
                            <div class="summary-card-value" id="totalConsultations">0</div>
                            <div class="summary-card-label">Consultations</div>
                        </div>
                        <div class="summary-card-icon">🩺</div>
                    </div>
                    <div class="summary-card-trend">↑ +15% from last month</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <h2 class="summary-title">📈 Data Visualization</h2>
            
            <div class="charts-grid">
                <!-- Patient Demographics Chart -->
                <div class="chart-container">
                    <h3 class="chart-title">Patient Demographics</h3>
                    <div class="chart-wrapper">
                        <canvas id="demographicsChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Visits Chart -->
                <div class="chart-container">
                    <h3 class="chart-title">Monthly Visits Trend</h3>
                    <div class="chart-wrapper">
                        <canvas id="visitsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Appointment Status Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Appointment Status Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="appointmentChart"></canvas>
                </div>
            </div>

            <!-- Medicine Inventory Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Medicine Inventory Status</h3>
                <div class="chart-wrapper">
                    <canvas id="inventoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="data-table-section">
            <h2 class="summary-title">📋 Recent Activities</h2>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Patient Name</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="activitiesTable">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px;">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <div class="report-footer">
            <p><strong>Norzagaray College - iClinic Management System</strong></p>
            <p>This is a computer-generated report. No signature required.</p>
            <p>For inquiries, contact the clinic administration office.</p>
        </div>
    </div>

    <!-- Print Button -->
    <button class="print-button no-print" onclick="window.print()">
        🖨️ Print Report
    </button>

    <script>
        // Set current date
        document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Load data from API
        async function loadReportData() {
            try {
                // Load patients
                const patientsRes = await fetch('/api/patients');
                const patientsData = await patientsRes.json();
                document.getElementById('totalPatients').textContent = patientsData.patients?.length || 0;

                // Load appointments
                const appointmentsRes = await fetch('/api/appointments');
                const appointmentsData = await appointmentsRes.json();
                document.getElementById('totalAppointments').textContent = appointmentsData.appointments?.length || 0;

                // Load medicines
                const medicinesRes = await fetch('/api/medicine');
                const medicinesData = await medicinesRes.json();
                document.getElementById('totalMedicines').textContent = medicinesData.medicines?.length || 0;

                // Load consultations
                const consultationsRes = await fetch('/api/consultations');
                const consultationsData = await consultationsRes.json();
                document.getElementById('totalConsultations').textContent = consultationsData.consultations?.length || 0;

                // Initialize charts with real data
                initializeCharts(patientsData, appointmentsData, medicinesData);
                
                // Populate activities table
                populateActivitiesTable(patientsData, appointmentsData);

            } catch (error) {
                console.error('Error loading report data:', error);
            }
        }

        // Initialize all charts
        function initializeCharts(patientsData, appointmentsData, medicinesData) {
            // Patient Demographics Chart
            const demographics = {
                students: patientsData.patients?.filter(p => p.role === 'Student').length || 0,
                teaching: patientsData.patients?.filter(p => p.role === 'Teaching Staff').length || 0,
                nonTeaching: patientsData.patients?.filter(p => p.role === 'Non-Teaching Staff').length || 0,
                visitors: patientsData.patients?.filter(p => p.role === 'Visitor').length || 0
            };

            new Chart(document.getElementById('demographicsChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Students', 'Teaching Staff', 'Non-Teaching Staff', 'Visitors'],
                    datasets: [{
                        data: [demographics.students, demographics.teaching, demographics.nonTeaching, demographics.visitors],
                        backgroundColor: ['#0056b3', '#10b981', '#f59e0b', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Monthly Visits Chart
            new Chart(document.getElementById('visitsChart'), {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Visits',
                        data: [45, 52, 48, 65, 72, 68, 85, 92, 88, 95, 0, 0],
                        borderColor: '#0056b3',
                        backgroundColor: 'rgba(0, 86, 179, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Appointment Status Chart
            const confirmed = appointmentsData.appointments?.filter(a => a.status === 'Confirmed').length || 0;
            const pending = appointmentsData.appointments?.filter(a => a.status === 'Pending').length || 0;
            const completed = appointmentsData.appointments?.filter(a => a.status === 'Completed').length || 0;

            new Chart(document.getElementById('appointmentChart'), {
                type: 'bar',
                data: {
                    labels: ['Confirmed', 'Pending', 'Completed'],
                    datasets: [{
                        label: 'Appointments',
                        data: [confirmed, pending, completed],
                        backgroundColor: ['#10b981', '#f59e0b', '#0056b3']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Medicine Inventory Chart
            const medicines = medicinesData.medicines?.slice(0, 8) || [];
            new Chart(document.getElementById('inventoryChart'), {
                type: 'bar',
                data: {
                    labels: medicines.map(m => m.name || 'Unknown'),
                    datasets: [{
                        label: 'Stock Level',
                        data: medicines.map(m => m.quantity || 0),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Populate activities table
        function populateActivitiesTable(patientsData, appointmentsData) {
            const tbody = document.getElementById('activitiesTable');
            tbody.innerHTML = '';

            const appointments = appointmentsData.appointments?.slice(0, 10) || [];
            
            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No recent activities</td></tr>';
                return;
            }

            appointments.forEach(apt => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(apt.date).toLocaleDateString()}</td>
                    <td>${apt.patient || 'N/A'}</td>
                    <td>${apt.type || 'General'}</td>
                    <td><span style="color: ${apt.status === 'Completed' ? '#10b981' : apt.status === 'Confirmed' ? '#0056b3' : '#f59e0b'}; font-weight: 600;">${apt.status}</span></td>
                    <td>${apt.notes || 'No remarks'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load data on page load
        loadReportData();
    </script>
</body>
</html>
